# Decomposed Implementation Plan: Package orrery as CLI
# This breaks down the feature-level plan into concrete implementation steps.
# Source: work/plans/2026-01-14-package-orrery-as-cli.yaml

metadata:
  created_at: "2026-01-14T18:00:00Z"
  created_by: "Claude"
  version: "1.0"
  parent_plan: "work/plans/2026-01-14-package-orrery-as-cli.yaml"
  summary: |
    Transform orrery into a globally installable npm CLI tool.
    After completion, users can run: npm install -g orrery && orrery install-skills

steps:
  # ============================================================================
  # PHASE 1: Package Structure (feature-1)
  # ============================================================================

  - id: "1.1"
    description: "Update package.json with CLI configuration"
    status: "pending"
    deps: []
    parallel: false
    criteria:
      - "package.json has bin.orrery pointing to bin/orrery.js"
      - "main field points to lib/index.js"
      - "commander dependency is added"
      - "type: module is set for ES modules"
    files:
      - "package.json"

  - id: "1.2"
    description: "Create CLI entry point with subcommand routing"
    status: "pending"
    deps: ["1.1"]
    parallel: false
    criteria:
      - "bin/orrery.js exists with shebang"
      - "Imports commander and sets up program"
      - "Routes to subcommands: install-skills, orchestrate, status, help"
      - "Running node bin/orrery.js --help shows commands"
    files:
      - "bin/orrery.js"

  - id: "1.3"
    description: "Create CLI command structure with placeholder commands"
    status: "pending"
    deps: ["1.2"]
    parallel: false
    criteria:
      - "lib/cli/commands/install-skills.js exports command function"
      - "lib/cli/commands/orchestrate.js exports command function"
      - "lib/cli/commands/status.js exports command function"
      - "Each command prints 'not implemented' placeholder"
    files:
      - "lib/cli/commands/install-skills.js"
      - "lib/cli/commands/orchestrate.js"
      - "lib/cli/commands/status.js"
      - "lib/cli/commands/index.js"

  - id: "1.4"
    description: "Verify package structure with npm pack and npm link"
    status: "pending"
    deps: ["1.3"]
    parallel: false
    criteria:
      - "npm pack produces a tarball without errors"
      - "npm link makes 'orrery' command available"
      - "orrery --help shows all subcommands"
    commands:
      - "npm pack --dry-run"
      - "npm link"
      - "orrery --help"

  # ============================================================================
  # PHASE 2: Self-Contained Skills (feature-2) - Can run parallel to Phase 1
  # ============================================================================

  - id: "2.1"
    description: "Copy plan-schema.yaml into plan skill directory"
    status: "pending"
    deps: []
    parallel: true
    criteria:
      - "agent/skills/plan/schemas/plan-schema.yaml exists"
      - "Content matches agent/schemas/plan-schema.yaml"
    files:
      - "agent/skills/plan/schemas/plan-schema.yaml"

  - id: "2.2"
    description: "Copy plan-schema.yaml into execute skill directory"
    status: "pending"
    deps: []
    parallel: true
    criteria:
      - "agent/skills/execute/schemas/plan-schema.yaml exists"
      - "Content matches agent/schemas/plan-schema.yaml"
    files:
      - "agent/skills/execute/schemas/plan-schema.yaml"

  - id: "2.3"
    description: "Copy report-schema.yaml into report skill directory"
    status: "pending"
    deps: []
    parallel: true
    criteria:
      - "agent/skills/report/schemas/report-schema.yaml exists"
      - "Content matches agent/schemas/report-schema.yaml"
    files:
      - "agent/skills/report/schemas/report-schema.yaml"

  - id: "2.4"
    description: "Copy discovery-plan-schema.yaml into discovery skill directory"
    status: "pending"
    deps: []
    parallel: true
    criteria:
      - "agent/skills/discovery/schemas/discovery-plan-schema.yaml exists"
      - "Content matches agent/schemas/discovery-plan-schema.yaml"
    files:
      - "agent/skills/discovery/schemas/discovery-plan-schema.yaml"

  - id: "2.5"
    description: "Update SKILL.md files to reference local schemas"
    status: "pending"
    deps: ["2.1", "2.2", "2.3", "2.4"]
    parallel: false
    criteria:
      - "plan/SKILL.md references ./schemas/plan-schema.yaml"
      - "execute/SKILL.md references ./schemas/plan-schema.yaml"
      - "report/SKILL.md references ./schemas/report-schema.yaml"
      - "discovery/SKILL.md references ./schemas/discovery-plan-schema.yaml"
      - "No SKILL.md references agent/schemas/"
    files:
      - "agent/skills/plan/SKILL.md"
      - "agent/skills/execute/SKILL.md"
      - "agent/skills/report/SKILL.md"
      - "agent/skills/discovery/SKILL.md"

  # ============================================================================
  # PHASE 3: Work Directory Configuration (feature-4) - Can run parallel
  # ============================================================================

  - id: "3.1"
    description: "Create paths utility module for work directory resolution"
    status: "pending"
    deps: []
    parallel: true
    criteria:
      - "lib/utils/paths.js exports getWorkDir(), getPlansDir(), getCompletedDir(), getReportsDir()"
      - "Default work dir is .agent-work/"
      - "Respects ORRERY_WORK_DIR environment variable"
    files:
      - "lib/utils/paths.js"

  - id: "3.2"
    description: "Update orchestrator.config.js to use new paths module"
    status: "pending"
    deps: ["3.1"]
    parallel: false
    criteria:
      - "Config imports from lib/utils/paths.js"
      - "WORK_DIR defaults to .agent-work/"
      - "PLANS_DIR is .agent-work/plans/"
      - "COMPLETED_DIR is .agent-work/completed/"
    files:
      - "agent/scripts/config/orchestrator.config.js"

  - id: "3.3"
    description: "Update orchestrate.js to use new paths configuration"
    status: "pending"
    deps: ["3.2"]
    parallel: false
    criteria:
      - "Orchestrator reads from .agent-work/plans/"
      - "Completed plans move to .agent-work/completed/"
      - "Creates .agent-work/ if it doesn't exist"
    files:
      - "agent/scripts/orchestrate.js"

  # ============================================================================
  # PHASE 4: Update Skill Instructions (feature-7)
  # ============================================================================

  - id: "4.1"
    description: "Update plan skill to reference .agent-work/"
    status: "pending"
    deps: ["3.1"]
    parallel: true
    criteria:
      - "SKILL.md references .agent-work/plans/ for output"
      - "No references to work/plans remain"
    files:
      - "agent/skills/plan/SKILL.md"

  - id: "4.2"
    description: "Update execute skill to reference .agent-work/"
    status: "pending"
    deps: ["3.1"]
    parallel: true
    criteria:
      - "SKILL.md references .agent-work/plans/ for reading plans"
      - "No references to work/plans remain"
    files:
      - "agent/skills/execute/SKILL.md"

  - id: "4.3"
    description: "Update report skill to reference .agent-work/"
    status: "pending"
    deps: ["3.1"]
    parallel: true
    criteria:
      - "SKILL.md references .agent-work/reports/ for output"
      - "No references to work/reports remain"
    files:
      - "agent/skills/report/SKILL.md"

  - id: "4.4"
    description: "Update remaining skills to reference .agent-work/"
    status: "pending"
    deps: ["3.1"]
    parallel: true
    criteria:
      - "All SKILL.md files use .agent-work/ consistently"
      - "grep -r 'work/plans' agent/skills/ returns no results"
    files:
      - "agent/skills/intake/SKILL.md"
      - "agent/skills/verify/SKILL.md"
      - "agent/skills/discovery/SKILL.md"

  # ============================================================================
  # PHASE 5: Install Skills Command (feature-3)
  # ============================================================================

  - id: "5.1"
    description: "Create agent detector utility"
    status: "pending"
    deps: ["2.5"]
    parallel: false
    criteria:
      - "lib/utils/agent-detector.js exports detectInstalledAgents()"
      - "Checks for ~/.claude/, ~/.codex/, ~/.gemini/"
      - "Returns array of detected agent names"
    files:
      - "lib/utils/agent-detector.js"

  - id: "5.2"
    description: "Create skill copier utility"
    status: "pending"
    deps: ["5.1"]
    parallel: false
    criteria:
      - "lib/utils/skill-copier.js exports copySkillsToAgent(agentName, options)"
      - "Copies from package's agent/skills/ to ~/.{agent}/skills/"
      - "Supports force and dryRun options"
      - "Returns list of copied skills"
    files:
      - "lib/utils/skill-copier.js"

  - id: "5.3"
    description: "Implement install-skills command"
    status: "pending"
    deps: ["5.2"]
    parallel: false
    criteria:
      - "orrery install-skills auto-detects agents"
      - "orrery install-skills --agent claude installs to Claude only"
      - "orrery install-skills --dry-run shows what would be copied"
      - "orrery install-skills --force overwrites existing"
      - "Clear output showing what was installed"
    files:
      - "lib/cli/commands/install-skills.js"
    commands:
      - "orrery install-skills --dry-run"

  # ============================================================================
  # PHASE 6: Orchestrate Command (feature-5)
  # ============================================================================

  - id: "6.1"
    description: "Implement orchestrate command wrapper"
    status: "pending"
    deps: ["1.4", "3.3"]
    parallel: false
    criteria:
      - "orrery orchestrate runs orchestration from current directory"
      - "orrery orchestrate --plan <file> runs specific plan"
      - "orrery orchestrate --dry-run shows what would be executed"
      - "orrery orchestrate --verbose shows detailed output"
      - "Exit codes: 0 for success, 1 for failure"
    files:
      - "lib/cli/commands/orchestrate.js"

  # ============================================================================
  # PHASE 7: Status Command (feature-6)
  # ============================================================================

  - id: "7.1"
    description: "Implement status command"
    status: "pending"
    deps: ["3.3"]
    parallel: false
    criteria:
      - "orrery status shows summary of all plans"
      - "orrery status --plan <file> shows detailed step status"
      - "Color-coded output: green=complete, yellow=in_progress, red=blocked"
      - "Shows 'No plans found' when .agent-work/plans/ is empty"
    files:
      - "lib/cli/commands/status.js"

  # ============================================================================
  # PHASE 8: Documentation (feature-8)
  # ============================================================================

  - id: "8.1"
    description: "Update README with installation and usage instructions"
    status: "pending"
    deps: ["5.3", "6.1", "7.1"]
    parallel: false
    criteria:
      - "README explains: npm install -g orrery"
      - "README documents all CLI commands with examples"
      - "README explains the skill installation model"
      - "New user can follow README to install and use orrery"
    files:
      - "README.md"

  # ============================================================================
  # PHASE 9: Final Verification
  # ============================================================================

  - id: "9.1"
    description: "End-to-end verification of CLI package"
    status: "pending"
    deps: ["8.1"]
    parallel: false
    criteria:
      - "npm pack produces valid tarball"
      - "Fresh npm install -g from tarball works"
      - "orrery install-skills installs to ~/.claude/skills/"
      - "orrery status works in a project directory"
      - "All skills are self-contained (no external schema references)"
    commands:
      - "npm pack"
      - "npm install -g ./orrery-1.0.0.tgz"
      - "orrery install-skills --dry-run"
      - "orrery status"
